<html>
  <head>
    <meta charset="utf8">
    <title>Basic Fetch() Progress Indicator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="../favicon.ico" type="image/png" />
    <style>
      body {
        text-align: center;
        font-size: 16px;
        padding: 1rem 0;
        display: flex;
        flex-flow: column nowrap;
        justify-content: space-between; 
      }
      #img {
        width: 600px;
        max-width: 100%;
        margin-bottom: 1rem;
        display: inline-block;
      }
      button {
        display: block;
        margin: 0 auto;
      }
      footer a {
        padding: 1em;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="status">&nbsp;</div>
      <h1 id="progress">&nbsp;</h1>
      <img id="img" />
      <button onclick="window.location.reload()">Reload</button>
    </main>
    <footer>
      <a href="/">Home</a>
      <a href="https://github.com/AnthumChris/fetch-progress-indicators">View on GitHub</a>
    </footer>

    <script>
      const elStatus = document.getElementById('status');
      const elProgress = document.getElementById('progress');

      status('downloading...');
      fetch('https://fetch-progress.anthum.com/30kbps/images/sunrise-baseline.jpg')
      .then(response => {
        if (!response.ok) {
          throw Error(response.status+' '+response.statusText)
        }

        if (!response.body) {
          throw Error('ReadableStream not yet supported in this browser.')
        }

        const contentLength = response.headers.get('content-length');
        if (!contentLength) {
          throw Error('Content-Length response header unavailable');
        }

        const total = parseInt(contentLength, 10);
        let loaded = 0;

        return new Response(
          new ReadableStream({
            start(controller) {
              const reader = response.body.getReader();

              read();
              function read() {
                reader.read().then(({done, value}) => {
                  if (done) {
                    controller.close();
                    return; 
                  }
                  loaded += value.byteLength;
                  progress({loaded, total})
                  controller.enqueue(value);
                  read();
                }).catch(error => {
                  console.error(error);
                  controller.error(error)                  
                })
              }
            }
          })
        );
      })
      .then(response => response.blob())
      .then(data => {
        status('download completed')
        document.getElementById('img').src = URL.createObjectURL(data);
      })
      .catch(error => {
        console.error(error);
        status(error);
      })

      function progress({loaded, total}) {
        elProgress.innerHTML = Math.round(loaded/total*100)+'%';
      }

      function status(text) {
        elStatus.innerHTML = text;
      }
    </script>
  </body>
</html>
